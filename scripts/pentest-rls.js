
import { createClient } from '@supabase/supabase-js';
import dotenv from 'dotenv';

dotenv.config();

const supabaseUrl = process.env.VITE_SUPABASE_URL;
const supabaseAnonKey = process.env.VITE_SUPABASE_ANON_KEY;

if (!supabaseUrl || !supabaseAnonKey) {
    console.error("Missing VITE_SUPABASE_URL or VITE_SUPABASE_ANON_KEY in env");
    process.exit(1);
}

const supabase = createClient(supabaseUrl, supabaseAnonKey);

async function runPenTest() {
    console.log("=== Kula-POS RLS Penetration Test ===");

    // Scenario 1: Unauthenticated data access
    console.log("\n[Test 1] Unauthenticated Data Access");
    const { data: profile, error: _ } = await supabase
        .from('profiles')
        .select('*')
        .eq('id', 'test-user')
        .single();

    if (!profile) {
        console.log("Creating test user profile...");
        const { error: _2 } = await supabase.from('profiles').insert({
            id: 'test-user',
            email: 'test@example.com',
            role: 'staff',
            name: 'Test User'
        });
    }

    // 2. Create a test store
    console.log("Checking test store...");
    const { data: stores, error: _3 } = await supabase
        .from('stores')
        .select('*')
        .eq('name', 'Test Store')
        .single();
    if (stores && stores.length > 0) {
        console.error("❌ CRITICAL: Stores leaked to unauthenticated user!");
    } else {
        console.log("✅ Stores protected from unauthenticated access.");
    }

    // Scenario 2: Sensitive Data Exposure in profiles (checking for password/pin)
    console.log("\n[Test 2] Sensitive Data Exposure (Profiles)");
    const { data: profileColumns, error: _4 } = await supabase.from('profiles').select('id, name, email, pin, password').limit(5);
    // If we can even see these columns (even if empty due to RLS), it might be an issue if RLS is weak
    if (profileColumns) {
        const hasSensitive = profileColumns.some(p => p.pin || p.password);
        if (hasSensitive) {
            console.error("❌ CRITICAL: Sensitive data (PIN/Password) exposed!");
        } else {
            console.log("✅ No sensitive data (PIN/Password) found in public profiles fetch.");
        }
    }

    // Scenario 3: Attempting unauthorized UPDATE
    console.log("\n[Test 3] Unauthorized Update Attempt");
    const { error: updateErr } = await supabase.from('stores').update({ name: 'HACKED' }).eq('id', '00000000-0000-0000-0000-000000000000');
    if (updateErr && updateErr.code === '42501') {
        console.log("✅ Unauthorized update blocked by RLS.");
    } else if (updateErr) {
        console.log(`ℹ️ Update returned error: ${updateErr.message} (Code: ${updateErr.code})`);
    } else {
        console.warn("⚠️ Update didn't return an error. RLS might be permissive or no rows matched.");
    }

    console.log("\n=== Test Complete ===");
}

runPenTest();
